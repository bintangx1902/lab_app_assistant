{% extends 'base-3.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
<style>
  button {
    padding: 0.5rem 1rem;
    margin: 0.8rem;
    background-color: #CCFBF1;
    color: #115E59;
    border-radius: 0.5rem ;
  }
  span {
    padding: 0.5rem 1rem;
    background-color: #CCFBF1;
    color: #115E59;
    border-radius: 0.5rem ;

  }
</style>
{% endblock %}

{% block content %}


<main class="" style="width: 100vw">
    <div
      class="absolute inset-0 -z-20 h-full w-full bg-white bg-[linear-gradient(to_right,#f0f0f0_1px,transparent_1px),linear-gradient(to_bottom,#f0f0f0_1px,transparent_1px)] bg-[size:6rem_4rem]">
      <div
        class="absolute bottom-0 left-0 right-0 top-0 bg-[radial-gradient(circle_500px_at_50%_200px,#f8fafc,transparent)]"></div>
    </div>
    <div class="lg:flex py-2 lg:justify-evenly">
      <div class="flex items-center lg:items-start gap-4 px-1 pb-5">
        <div class="flex">
          <a href="/" type="submit">
            <div
              class="flex items-center p-1 rounded-xl text-slate-600 flex-col bg-white border border-gray-200 shadow-sm md:p-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                width="24"
                height="24"
                class="size-8"
                stroke-width="1.5"
                stroke="currentColor"
                class="size-6">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 19.5 8.25 12l7.5-7.5" />
              </svg>
            </div>
          </a>
        </div>

        <div>
          <div
            class="py-3 px-2 flex gap-4 shadow rounded-lg flex-1"
            style="background-color: white">
            <div
              class="flex items-center p-2 rounded-full"
              style="background-color: #eaf3ff; color: #3185fe">
              <svg
                class="shrink-0 size-6 text-blue"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round">
                <rect width="10" height="14" x="3" y="8" rx="2" />
                <path
                  d="M5 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-2.4" />
                <path d="M8 18h.01" />
              </svg>
            </div>
            <div class="flex flex-col">
              <p class="font-semibold text-base">Presensi</p>
              <p class="font-light text-sm text-slate-800">
                Cek dan Catat Kehadiran
              </p>
            </div>
            <div></div>
          </div>
        </div>
      </div>

      <div
        class="mt-0 flex flex-col bg-white border border-gray-200 shadow-sm rounded-xl p-4 md:p-5">
        <p class="font-light py-2 text-sm" style="color: #acafb5">
          Hello there, scan to continue
        </p>
        <div class="mt-0">
            <div class="container mt-5">
                <script src="{% static 'user/js/html5.qrcode.min.js' %}"></script>
            
                <div class="d-lg-flex">
                    <div class="col-lg col mx-auto p-4">
                        <div class="card flex items-center justify-center p-4">
                            <div class="card-body">
                                <div id="reader"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg col mx-auto">
                        <h4>SCAN RESULT</h4>
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
  </main>

{% csrf_token %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script type="text/javascript">
    let token = document.getElementsByName("csrfmiddlewaretoken");
    console.log(token[0].value)
    let handle;

    function onScanSuccess(decodedText, decodedResult) {
        axios({
            method: 'post',
            url: '{% url "api:take-presence" %}?format=json',
            headers: {
                'X-CSRFToken': token[0].value,
                'Content-Type': 'Application/json'
            },
            data: {
                "code": String(decodedText),
                "number": "{{ request.user.id }}"
            }
        })
            .then(response => {
                alert(response.data.text)
                window.location.replace('{% url "presence:landing" %}')
            })
            .catch(error => {
                onScanFailure(error.response.data.text)
                alert(handle)
                window.location.replace('{% url "presence:landing" %}')
            })
        // document.getElementById('result').innerHTML = '<span class="alert alert-info">' + handle + '</span>'
        // console.log(`Code matched = ${decodedText}`, decodedResult);
    }

    function onScanFailure(error) {
        handle = error;
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader",
        {fps: 10, qrbox: {width: 250, height: 250}},
        /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

</script>
{% endblock %}